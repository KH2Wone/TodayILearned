# async VS defer 스크립트 로딩

<br>

## 우선 브라우저의 동작 원리를 가볍게 생각해봅시다.

브라우저는 HTML을 읽다가 `<script></script>` 태그를 만나면 스크립트를 실행하기 위해 DOM 생성을 멈춘 뒤 자바스크립트 엔진에게 제어권을 주게 되고 파싱이 끝나면 다시 렌더링 엔진에게 제어권을 넘겨 중단된 부분부터 재개합니다.

> 이러한 방식의 문제점

```
1. 중간에 스크립트를 만나 실행하게 되면 스크립트 하단에 있는 DOM Element를 보지 못하므로 핸들링할 수 없다.
2. 스크립트가 크고 페이지 상단에 위치하게 되면 로딩되는 동안 렌더링 블로킹(페이지를 막음)이 일어나 유저들이 페이지 컨텐츠를 볼 수 없다.
```

이러한 문제로 스크립트 태그를 바디 태그의 최하단에 위치하는 방법이 가장 좋은 방법이긴 합니다. (그동안 권장했던 방식이기도 합니다)  
그러나 이는 작은 대안일 뿐이고 HTML 파일이 클 경우 그만큼 스크립트 로드 시작점도 함께 느려지므로 문제가 될 수 있습니다.

<br>

## 안녕 친구들, 해결사가 왔어

이러한 문제점을 해결하기 위해 **async**와 **defer**라는 속성이 있습니다.

우선 두 가지의 속성의 공통점은 스크립트 다운로드 시 **페이지 렌더링을 막지 않는 장점**이 있습니다.  
백그라운드에서 다운로드되기 때문입니다. 즉, HTML 코드를 처리하는 동안 스크립트 파일 또한 백그라운드에서 다운로드합니다.

> 그럼 두 가지는 무엇이 다를까요?

다운로드 후 해당 스크립트를 실행하는 **타이밍**이 다릅니다.

<br>

## async

```html
<script async src="https://javascript.info/article/script-async-defer/long.js"></script>
<script async src="https://javascript.info/article/script-async-defer/small.js"></script>
```

페이지와 완전히 독립적으로 동작합니다.
defer는 스크립트 간의 relative order를 지키지만 async는 매우 독립적이라서 로드가 되고 나서 바로 실행합니다.  
async 속성을 사용하면 브라우저는 HTML 코드를 처리하는 동안 자바스크립트 파일을 내려받을 뿐만 아니라 다운로드가 끝나자마자 해당 자바스크립트 코드를 실행합니다. 따라서 해당 자바스크립트 코드가 어느 시점에 다운로드되어 실행이 될지 알 수 없습니다.

여러 개의 독립된 자바스크립트 파일을 삽입하는 경우 사용하면 성능 측면에서 좋습니다.
문서 내 순서와 상관없이 다운로드 완료 즉시 실행되기 때문입니다. 예를 들어 사이즈가 작은 스크립트 파일이 먼저 다운로드 완료되고 다른 스크립트 파일에 비해 먼저 실행되겠지요.

<br>

## defer

```html
<script defer src="https://javascript.info/article/script-async-defer/long.js"></script>
<script defer src="https://javascript.info/article/script-async-defer/small.js"></script>
```

브라우저는 HTML 코드를 처리함과 동시에 자바스크립트 파일도 내려받습니다.  
해당 스크립트 태그가 HTML 문서 내 어디에 위치하더라도 마치 `<body></body>` 엘리먼트의 제일 마지막에 넣은 것처럼 HTML 코드가 모두 처리된 이후에 자바스크립트 코드가 실행됩니다.

예를 들어 HTML 읽는데 1초가 걸리고 스크립트 코드를 읽는데 0.8초가 걸린다면 HTML 코드가 처리되자 마자 실행될 수 있습니다.

서로 연관(의존성)이 있는 여러 개의 스크립트 파일을 순차적으로 실행하는 경우 사용합니다.
즉, DOM 전체가 필요하거나 스크립트 실행 순서가 중요하다면 defer를 사용하면 좋습니다.
문서에 추가된 순서대로 실행하기 때문입니다.

### 유의할 점

defer는 스크립트가 실행되기 전에 페이지가 화면에 그려집니다.  
그러면 사용자는 JS 관련 컴포넌트들이 준비되지 않은 상태의 정적인 화면을 마주하게 됩니다. 그래서 지연 스크립트에 영향을 받는 부분이 있다면 로딩 인디케이터가 존재해야 합니다.

<br>

### 참고

- [<script>로 HTML 문서에 자바스크립트 넣기 (feat. defer & async)](https://www.daleseo.com/js-script-defer-async/)
- [defer, async 스크립트](https://ko.javascript.info/script-async-defer)
